<!DOCTYPE html>
<html>
<head>
    <title>CoffeeMap</title>
    <meta charset="utf-8">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: sans-serif; }
        #map { width: 100%; height: 100vh; }
        
        .sidebar {
            position: absolute;
            top: 0;
            right: 0;
            width: 380px;
            height: 100vh;
            background: white;
            box-shadow: -2px 0 8px rgba(0,0,0,0.1);
            z-index: 999;
            overflow-y: auto;
        }
        
        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid #e0e0e0;
            background: white;
        }
        
        .cafe-item {
            padding: 16px 20px;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
        }
        
        .cafe-item:hover { background: #f9f9f9; }
        
        .cafe-header {
            display: flex;
            gap: 12px;
            align-items: center;
        }
        
        .signal-dot {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            flex-shrink: 0;
        }
        
        .signal-green { background: #4CAF50; }
        .signal-yellow { background: #FFC107; }
        .signal-red { background: #F44336; }
        .signal-gray { background: #9E9E9E; }
        
        .cafe-name { font-size: 15px; font-weight: 600; margin-bottom: 4px; }
        .cafe-address { font-size: 12px; color: #666; }
        
        .cafe-indicators {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-top: 8px;
        }
        
        .indicator {
            font-size: 11px;
            padding: 4px 8px;
            background: #f5f5f5;
            border-radius: 12px;
        }
        
        .custom-marker {
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            position: relative;
        }
        
        .marker-icon {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
            transition: all 0.2s;
            box-shadow: 0 2px 8px rgba(0,0,0,0.25);
            background: white;
        }
        
        .marker-icon:hover {
            transform: scale(1.15);
        }
        
        .marker-icon.green { 
            border: 3px solid #4CAF50;
            z-index: 1000 !important;
        }
        .marker-icon.yellow { 
            border: 3px solid #FFC107;
            z-index: 900 !important;
        }
        .marker-icon.red { 
            border: 3px solid #F44336;
            z-index: 800 !important;
        }
        .marker-icon.gray { 
            border: 3px solid #9E9E9E;
            z-index: 700 !important;
        }
        
        .marker-icon.green.active { background: #4CAF50; }
        .marker-icon.yellow.active { background: #FFC107; }
        .marker-icon.red.active { background: #F44336; }
        .marker-icon.gray.active { background: #9E9E9E; }
        
        .marker-icon::before {
            content: 'â˜•';
            font-size: 24px;
            display: block;
        }
        
        .marker-icon.green::before { color: #4CAF50; }
        .marker-icon.yellow::before { color: #FFC107; }
        .marker-icon.red::before { color: #F44336; }
        .marker-icon.gray::before { color: #9E9E9E; }
        
        .marker-icon.active::before {
            color: white;
        }
        
        .marker-score {
            font-size: 11px;
            font-weight: bold;
            margin-top: -3px;
            color: #333;
        }
        
        .marker-icon.active .marker-score {
            color: white;
        }
        
        .marker-name {
            font-size: 11px;
            font-weight: 600;
            color: #333;
            background: white;
            padding: 2px 6px;
            border-radius: 3px;
            margin-top: 4px;
            white-space: nowrap;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
            max-width: 120px;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .marker-name.hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="sidebar">
        <div class="sidebar-header">
            <div style="font-size:18px;font-weight:600;">Cafes</div>
            <div id="cafeCount" style="font-size:13px;color:#666;margin-top:4px;">Loading...</div>
        </div>
        <div id="cafeList"></div>
    </div>
    
    <div id="map"></div>

    <script src="config.js"></script>
    <script src="http://dapi.kakao.com/v2/maps/sdk.js?appkey=1b39ab278b34720c916eff1fe31ea422&libraries=services"></script>
    <script>
        console.log('=== ìŠ¤í¬ë¦½íŠ¸ ì‹œì‘ ===');
        
        let map, allCafes = [], markers = [], activeMarkerIdx = null;
        
        window.addEventListener('load', function() {
            console.log('í˜ì´ì§€ ë¡œë“œë¨');
            if (typeof kakao !== 'undefined' && kakao.maps) {
                kakao.maps.load(initMap);
            } else {
                console.error('ì¹´ì¹´ì˜¤ ë§µ ë¡œë“œ ì‹¤íŒ¨');
            }
        });
        
        function initMap() {
            console.log('ì§€ë„ ì´ˆê¸°í™”');
            
            map = new kakao.maps.Map(document.getElementById('map'), {
                center: new kakao.maps.LatLng(37.3943, 126.9568),
                level: 5
            });
            
            kakao.maps.event.addListener(map, 'idle', searchCafes);
            searchCafes();
        }
        
        function searchCafes() {
            console.log('ì¹´í˜ ê²€ìƒ‰ ì‹œì‘');
            const ps = new kakao.maps.services.Places();
            const center = map.getCenter();
            
            ps.keywordSearch('ì¹´í˜', (data, status) => {
                console.log('ê²€ìƒ‰ ê²°ê³¼:', status, data ? data.length : 0);
                if (status === kakao.maps.services.Status.OK) {
                    allCafes = data.map(place => ({
                        name: place.place_name,
                        address: place.address_name,
                        phone: place.phone || '',
                        latitude: parseFloat(place.y),
                        longitude: parseFloat(place.x),
                        workScore: 0  // ì´ˆê¸°ê°’
                    }));
                    renderCafeList(allCafes);
                    displayMarkers(allCafes);
                }
            }, {
                location: new kakao.maps.LatLng(center.getLat(), center.getLng()),
                radius: 5000,
                category_group_code: 'CE7'
            });
        }
        
        function sortAndRenderCafes() {
            // ì‘ì—… ì ìˆ˜ ìˆœìœ¼ë¡œ ì •ë ¬
            const sorted = [...allCafes].sort((a, b) => {
                const scoreA = a.detailData ? a.detailData.workScore : 0;
                const scoreB = b.detailData ? b.detailData.workScore : 0;
                return scoreB - scoreA;
            });
            
            const list = document.getElementById('cafeList');
            document.getElementById('cafeCount').textContent = sorted.length + ' cafes';
            
            list.innerHTML = sorted.map((cafe) => {
                const idx = allCafes.indexOf(cafe);
                const data = cafe.detailData;
                const signalColor = data ? data.signalColor : 'gray';
                
                let indicatorsHtml = '<div class="indicator">ë¶„ì„ì¤‘...</div>';
                if (data) {
                    let html = '';
                    if (data.workScore > 0) html += '<div class="indicator">ğŸ’¼ ' + data.workScore + '/10</div>';
                    if (data.outletLevel !== 'ì •ë³´ ì—†ìŒ') html += '<div class="indicator">ğŸ”Œ ' + data.outletLevel + '</div>';
                    if (data.noiseLevel !== 'ì •ë³´ ì—†ìŒ') html += '<div class="indicator">ğŸ”‡ ' + data.noiseLevel + '</div>';
                    if (data.hasWifi) html += '<div class="indicator">ğŸ“¶ WiFi</div>';
                    if (data.blogCount > 0) html += '<div class="indicator">ğŸ“ ' + data.blogCount + '</div>';
                    indicatorsHtml = html || '<div class="indicator">ì •ë³´ ì—†ìŒ</div>';
                }
                
                return `
                    <div class="cafe-item" onclick="showCafeDetail(${idx})">
                        <div class="cafe-header">
                            <div class="signal-dot signal-${signalColor}"></div>
                            <div>
                                <div class="cafe-name">${cafe.name}</div>
                                <div class="cafe-address">${cafe.address}</div>
                            </div>
                        </div>
                        <div class="cafe-indicators">${indicatorsHtml}</div>
                    </div>
                `;
            }).join('');
        }
        
        function renderCafeList(cafes) {
            console.log('ë¦¬ìŠ¤íŠ¸ ë Œë”ë§:', cafes.length);
            const list = document.getElementById('cafeList');
            document.getElementById('cafeCount').textContent = cafes.length + ' cafes';
            
            list.innerHTML = cafes.map((cafe, idx) => `
                <div class="cafe-item" onclick="showCafeDetail(${idx})">
                    <div class="cafe-header">
                        <div class="signal-dot signal-gray" id="signal-${idx}"></div>
                        <div>
                            <div class="cafe-name">${cafe.name}</div>
                            <div class="cafe-address">${cafe.address}</div>
                        </div>
                    </div>
                    <div class="cafe-indicators" id="indicators-${idx}">
                        <div class="indicator">ë¶„ì„ì¤‘...</div>
                    </div>
                </div>
            `).join('');
            
            cafes.forEach((cafe, idx) => loadIndicators(cafe, idx));
        }
        
        function showCafeDetail(idx) {
            const cafe = allCafes[idx];
            if (!cafe.detailData) {
                alert('ë°ì´í„° ë¡œë”© ì¤‘ì…ë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            // ì´ì „ í™œì„± ë§ˆì»¤ ë¹„í™œì„±í™”
            if (activeMarkerIdx !== null) {
                const prevMarker = document.getElementById('marker-' + activeMarkerIdx);
                if (prevMarker) prevMarker.classList.remove('active');
            }
            
            // í˜„ì¬ ë§ˆì»¤ í™œì„±í™”
            const currentMarker = document.getElementById('marker-' + idx);
            if (currentMarker) currentMarker.classList.add('active');
            activeMarkerIdx = idx;
            
            showModal(cafe, cafe.detailData);
        }
        
        function showModal(cafe, data) {
            let html = '<h2 style="margin-bottom:20px;">' + cafe.name + '</h2>';
            
            // ì¹´ê³µ ì§€í‘œ ì¹´ë“œ
            html += '<div style="display:grid;grid-template-columns:repeat(2,1fr);gap:12px;margin:20px 0;">';
            
            if (data.workScore > 0) {
                html += '<div style="padding:16px;background:#e8f5e9;border-radius:8px;text-align:center;">' +
                    '<div style="font-size:24px;">ğŸ’¼</div>' +
                    '<div style="font-size:20px;font-weight:bold;margin:8px 0;">' + data.workScore + '/10</div>' +
                    '<div style="font-size:12px;color:#666;">ì‘ì—… ì í•©ë„</div></div>';
            }
            
            if (data.outletLevel !== 'ì •ë³´ ì—†ìŒ') {
                html += '<div style="padding:16px;background:#fff3e0;border-radius:8px;text-align:center;">' +
                    '<div style="font-size:24px;">ğŸ”Œ</div>' +
                    '<div style="font-size:14px;font-weight:bold;margin:8px 0;">' + data.outletLevel + '</div>' +
                    '<div style="font-size:12px;color:#666;">ì½˜ì„¼íŠ¸</div></div>';
            }
            
            if (data.noiseLevel !== 'ì •ë³´ ì—†ìŒ') {
                html += '<div style="padding:16px;background:#e3f2fd;border-radius:8px;text-align:center;">' +
                    '<div style="font-size:24px;">ğŸ”‡</div>' +
                    '<div style="font-size:14px;font-weight:bold;margin:8px 0;">' + data.noiseLevel + '</div>' +
                    '<div style="font-size:12px;color:#666;">ì†ŒìŒ ë ˆë²¨</div></div>';
            }
            
            if (data.tableHeight !== 'ì •ë³´ ì—†ìŒ') {
                html += '<div style="padding:16px;background:#f3e5f5;border-radius:8px;text-align:center;">' +
                    '<div style="font-size:24px;">ğŸ“</div>' +
                    '<div style="font-size:14px;font-weight:bold;margin:8px 0;">' + data.tableHeight + '</div>' +
                    '<div style="font-size:12px;color:#666;">í…Œì´ë¸” ë†’ì´</div></div>';
            }
            
            if (data.spaceLevel && data.spaceLevel !== 'ì •ë³´ ì—†ìŒ') {
                html += '<div style="padding:16px;background:#fff9c4;border-radius:8px;text-align:center;">' +
                    '<div style="font-size:24px;">ğŸ“</div>' +
                    '<div style="font-size:14px;font-weight:bold;margin:8px 0;">' + data.spaceLevel + '</div>' +
                    '<div style="font-size:12px;color:#666;">ê³µê°„ê°</div></div>';
            }
            
            html += '</div>';
            
            // ê¸°ë³¸ ì •ë³´
            html += '<div style="margin:20px 0;line-height:1.8;background:#f5f5f5;padding:16px;border-radius:8px;">';
            html += '<div>ğŸ“ ' + cafe.address + '</div>';
            if (cafe.phone) html += '<div>ğŸ“ ' + cafe.phone + '</div>';
            if (data.hasWifi) html += '<div>ğŸ“¶ WiFi ê°€ëŠ¥</div>';
            if (data.hasParking) html += '<div>ğŸ…¿ï¸ ì£¼ì°¨ ê°€ëŠ¥</div>';
            if (data.timeLimit !== 'ì •ë³´ ì—†ìŒ') html += '<div>â° ' + data.timeLimit + '</div>';
            html += '</div>';
            
            // í‚¤ì›Œë“œ ë¶„ì„
            if (data.keywords && Object.keys(data.keywords).length > 0) {
                html += '<div style="margin:20px 0;"><h3 style="font-size:14px;margin-bottom:10px;">ğŸ“Š ë¸”ë¡œê·¸ í‚¤ì›Œë“œ ë¶„ì„</h3>';
                html += '<div style="display:flex;gap:8px;flex-wrap:wrap;">';
                for (let key in data.keywords) {
                    if (data.keywords[key] > 0) {
                        html += '<span style="padding:6px 12px;background:#e0e0e0;border-radius:16px;font-size:12px;">' + 
                            key + ' (' + data.keywords[key] + ')</span>';
                    }
                }
                html += '</div></div>';
            }
            
            // ë¸”ë¡œê·¸ ë¦¬ë·°
            if (data.blogItems && data.blogItems.length > 0) {
                html += '<div style="margin-top:20px;"><h3 style="font-size:14px;margin-bottom:10px;">ğŸ“ ë¸”ë¡œê·¸ ë¦¬ë·° (' + data.blogItems.length + ')</h3>';
                data.blogItems.forEach(function(item, i) {
                    html += '<a href="' + item.url + '" target="_blank" style="display:block;padding:12px;margin:8px 0;background:#f9f9f9;border-radius:8px;text-decoration:none;color:#333;transition:background 0.2s;border-left:3px solid #4CAF50;" onmouseover="this.style.background=\'#f0f0f0\'" onmouseout="this.style.background=\'#f9f9f9\'">' +
                        '<div style="font-weight:600;font-size:13px;margin-bottom:6px;color:#222;">' + item.title + '</div>' +
                        '<div style="font-size:12px;color:#666;line-height:1.4;">' + item.description + '</div>' +
                        '</a>';
                });
                html += '</div>';
            } else if (data.blogUrls && data.blogUrls.length > 0) {
                // í•˜ìœ„ í˜¸í™˜ì„±
                html += '<div style="margin-top:20px;"><h3 style="font-size:14px;margin-bottom:10px;">ğŸ“ ë¸”ë¡œê·¸ ë¦¬ë·°</h3>';
                data.blogUrls.forEach(function(url, i) {
                    html += '<a href="' + url + '" target="_blank" style="display:block;padding:12px;margin:8px 0;background:#f0f0f0;border-radius:6px;text-decoration:none;color:#333;transition:background 0.2s;" onmouseover="this.style.background=\'#e0e0e0\'" onmouseout="this.style.background=\'#f0f0f0\'">ğŸ“ ë¸”ë¡œê·¸ ë¦¬ë·° ' + (i + 1) + '</a>';
                });
                html += '</div>';
            }
            
            const modal = document.createElement('div');
            modal.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);z-index:2000;display:flex;align-items:center;justify-content:center;padding:20px;';
            modal.innerHTML = '<div style="background:white;max-width:600px;max-height:80vh;overflow-y:auto;border-radius:12px;padding:30px;position:relative;width:100%;">' +
                '<span style="position:absolute;top:15px;right:20px;font-size:32px;cursor:pointer;color:#999;line-height:1;" onclick="this.parentElement.parentElement.remove()">Ã—</span>' +
                html + '</div>';
            modal.onclick = function(e) { 
                if (e.target === modal) modal.remove(); 
            };
            document.body.appendChild(modal);
        }
        
        function displayMarkers(cafes) {
            // ê¸°ì¡´ ë§ˆì»¤ ì œê±°
            markers.forEach(m => m.setMap(null));
            markers = [];
            
            cafes.forEach((cafe, idx) => {
                const content = document.createElement('div');
                content.className = 'custom-marker';
                content.innerHTML = '<div class="marker-icon gray" id="marker-' + idx + '">' +
                    '<div class="marker-score">-</div>' +
                    '</div>' +
                    '<div class="marker-name hidden" id="marker-name-' + idx + '">' + cafe.name + '</div>';
                
                const marker = new kakao.maps.CustomOverlay({
                    position: new kakao.maps.LatLng(cafe.latitude, cafe.longitude),
                    content: content,
                    yAnchor: 0.5,
                    zIndex: 700
                });
                
                marker.setMap(map);
                markers.push(marker);
                
                content.onclick = function() {
                    // ì´ì „ í™œì„± ë§ˆì»¤ ë¹„í™œì„±í™”
                    if (activeMarkerIdx !== null) {
                        const prevMarker = document.getElementById('marker-' + activeMarkerIdx);
                        if (prevMarker) prevMarker.classList.remove('active');
                    }
                    
                    // í˜„ì¬ ë§ˆì»¤ í™œì„±í™”
                    const currentMarker = document.getElementById('marker-' + idx);
                    if (currentMarker) currentMarker.classList.add('active');
                    activeMarkerIdx = idx;
                    
                    if (cafe.detailData) {
                        showModal(cafe, cafe.detailData);
                    } else {
                        alert('ë°ì´í„° ë¡œë”© ì¤‘ì…ë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
                    }
                };
            });
        }
        
        function updateMarker(idx, data) {
            const markerIcon = document.getElementById('marker-' + idx);
            if (markerIcon && data) {
                const oldColor = markerIcon.className.split(' ')[1];
                const newColor = data.signalColor || 'gray';
                markerIcon.className = 'marker-icon ' + newColor;
                
                // z-index ì—…ë°ì´íŠ¸
                const zIndexMap = { green: 1000, yellow: 900, red: 800, gray: 700 };
                if (markers[idx]) {
                    markers[idx].setZIndex(zIndexMap[newColor] || 700);
                }
                
                const scoreEl = markerIcon.querySelector('.marker-score');
                if (scoreEl && data.totalScore !== undefined) {
                    scoreEl.textContent = data.totalScore.toFixed(1);
                }
                
                // í‰ì ì´ ìˆìœ¼ë©´ ì¹´í˜ ì´ë¦„ í‘œì‹œ
                const nameEl = document.getElementById('marker-name-' + idx);
                if (nameEl && data.totalScore > 0) {
                    nameEl.classList.remove('hidden');
                }
            }
        }
        
        async function loadIndicators(cafe, idx) {
            try {
                const response = await fetch('http://localhost:5000/api/blog-search', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name: cafe.name, address: cafe.address })
                });
                const data = await response.json();
                
                // ì¹´í˜ ê°ì²´ì— ë°ì´í„° ì €ì¥
                allCafes[idx].detailData = data;
                
                // ë§ˆì»¤ ì—…ë°ì´íŠ¸
                updateMarker(idx, data);
                
                const signalDot = document.getElementById('signal-' + idx);
                if (signalDot) {
                    signalDot.className = 'signal-dot signal-' + (data.signalColor || 'gray');
                }
                
                const indicators = document.getElementById('indicators-' + idx);
                if (indicators) {
                    let html = '';
                    if (data.workScore > 0) html += '<div class="indicator">ğŸ’¼ ' + data.workScore + '/10</div>';
                    if (data.outletLevel !== 'ì •ë³´ ì—†ìŒ') html += '<div class="indicator">ğŸ”Œ ' + data.outletLevel + '</div>';
                    if (data.noiseLevel !== 'ì •ë³´ ì—†ìŒ') html += '<div class="indicator">ğŸ”‡ ' + data.noiseLevel + '</div>';
                    if (data.hasWifi) html += '<div class="indicator">ğŸ“¶ WiFi</div>';
                    if (data.blogCount > 0) html += '<div class="indicator">ğŸ“ ' + data.blogCount + '</div>';
                    
                    indicators.innerHTML = html || '<div class="indicator">ì •ë³´ ì—†ìŒ</div>';
                }
                
                // ëª¨ë“  ì¹´í˜ ë°ì´í„° ë¡œë“œ ì™„ë£Œ í™•ì¸ í›„ ì •ë ¬
                const loadedCount = allCafes.filter(c => c.detailData).length;
                if (loadedCount === allCafes.length) {
                    sortAndRenderCafes();
                }
            } catch (err) {
                console.log('ì§€í‘œ ë¡œë“œ ì‹¤íŒ¨:', cafe.name, err);
            }
        }
        
        function sortAndRenderCafes() {
            // ì‘ì—… ì ìˆ˜ ìˆœìœ¼ë¡œ ì •ë ¬
            const sorted = [...allCafes].sort((a, b) => {
                const scoreA = a.detailData ? a.detailData.workScore : 0;
                const scoreB = b.detailData ? b.detailData.workScore : 0;
                return scoreB - scoreA;
            });
            
            const list = document.getElementById('cafeList');
            
            list.innerHTML = sorted.map((cafe) => {
                const idx = allCafes.indexOf(cafe);
                const data = cafe.detailData;
                const signalColor = data ? data.signalColor : 'gray';
                
                let indicatorsHtml = '';
                if (data) {
                    if (data.workScore > 0) indicatorsHtml += '<div class="indicator">ğŸ’¼ ' + data.workScore + '/10</div>';
                    if (data.outletLevel && data.outletLevel !== 'ì •ë³´ ì—†ìŒ') indicatorsHtml += '<div class="indicator">ğŸ”Œ ' + data.outletLevel + '</div>';
                    if (data.noiseLevel && data.noiseLevel !== 'ì •ë³´ ì—†ìŒ') indicatorsHtml += '<div class="indicator">ğŸ”‡ ' + data.noiseLevel + '</div>';
                    if (data.spaceLevel && data.spaceLevel !== 'ì •ë³´ ì—†ìŒ') indicatorsHtml += '<div class="indicator">ğŸ“ ' + data.spaceLevel + '</div>';
                    if (data.hasWifi) indicatorsHtml += '<div class="indicator">ğŸ“¶ WiFi</div>';
                    if (data.blogCount > 0) indicatorsHtml += '<div class="indicator">ğŸ“ ' + data.blogCount + '</div>';
                    if (!indicatorsHtml) indicatorsHtml = '<div class="indicator">ì •ë³´ ì—†ìŒ</div>';
                }
                
                return '<div class="cafe-item" onclick="showCafeDetail(' + idx + ')">' +
                    '<div class="cafe-header">' +
                    '<div class="signal-dot signal-' + signalColor + '"></div>' +
                    '<div>' +
                    '<div class="cafe-name">' + cafe.name + '</div>' +
                    '<div class="cafe-address">' + cafe.address + '</div>' +
                    '</div></div>' +
                    '<div class="cafe-indicators">' + indicatorsHtml + '</div>' +
                    '</div>';
            }).join('');
        }
    </script>
</body>
</html>
