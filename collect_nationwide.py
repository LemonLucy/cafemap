#!/usr/bin/env python3
"""
ì „êµ­ ì¹´í˜ ë°ì´í„° ëŒ€ê·œëª¨ ìˆ˜ì§‘ (ì´ë¯¸ì§€ëŠ” ì¸ê¸° ì¹´í˜ë§Œ)
"""
import os
import sys
import time
import json

# í™˜ê²½ë³€ìˆ˜ ì„¤ì •
os.environ['DATABASE_URL'] = 'postgresql://cafemap:CafeMap2026Pass@localhost:5432/cafemap'
os.environ['NAVER_CLIENT_ID'] = 'tr30Ch1tbJBqwNlv9svx'
os.environ['NAVER_CLIENT_SECRET'] = 'fsrn1wXmk3'

from app_server import analyze_blog_content
from cache_db import init_cache_db, save_cached_result
from upload_images_to_oci import download_and_upload_blog_images

CACHE_VERSION = "v18"

# ì „êµ­ ì£¼ìš” ì‹œ/êµ°/êµ¬
REGIONS = [
    # ì„œìš¸ (25ê°œ êµ¬)
    "ì„œìš¸ ê°•ë‚¨êµ¬", "ì„œìš¸ ê°•ë™êµ¬", "ì„œìš¸ ê°•ë¶êµ¬", "ì„œìš¸ ê°•ì„œêµ¬", "ì„œìš¸ ê´€ì•…êµ¬",
    "ì„œìš¸ ê´‘ì§„êµ¬", "ì„œìš¸ êµ¬ë¡œêµ¬", "ì„œìš¸ ê¸ˆì²œêµ¬", "ì„œìš¸ ë…¸ì›êµ¬", "ì„œìš¸ ë„ë´‰êµ¬",
    "ì„œìš¸ ë™ëŒ€ë¬¸êµ¬", "ì„œìš¸ ë™ì‘êµ¬", "ì„œìš¸ ë§ˆí¬êµ¬", "ì„œìš¸ ì„œëŒ€ë¬¸êµ¬", "ì„œìš¸ ì„œì´ˆêµ¬",
    "ì„œìš¸ ì„±ë™êµ¬", "ì„œìš¸ ì„±ë¶êµ¬", "ì„œìš¸ ì†¡íŒŒêµ¬", "ì„œìš¸ ì–‘ì²œêµ¬", "ì„œìš¸ ì˜ë“±í¬êµ¬",
    "ì„œìš¸ ìš©ì‚°êµ¬", "ì„œìš¸ ì€í‰êµ¬", "ì„œìš¸ ì¢…ë¡œêµ¬", "ì„œìš¸ ì¤‘êµ¬", "ì„œìš¸ ì¤‘ë‘êµ¬",
    
    # ê²½ê¸° (31ê°œ ì‹œ/êµ°)
    "ìˆ˜ì›", "ì„±ë‚¨", "ê³ ì–‘", "ìš©ì¸", "ë¶€ì²œ", "ì•ˆì‚°", "ì•ˆì–‘", "ë‚¨ì–‘ì£¼", "í™”ì„±",
    "í‰íƒ", "ì˜ì •ë¶€", "ì‹œí¥", "íŒŒì£¼", "ê¹€í¬", "ê´‘ëª…", "ê´‘ì£¼", "êµ°í¬", "ì˜¤ì‚°",
    "ì´ì²œ", "ì–‘ì£¼", "ì•ˆì„±", "êµ¬ë¦¬", "í¬ì²œ", "ì˜ì™•", "í•˜ë‚¨", "ì—¬ì£¼", "ë™ë‘ì²œ",
    "ê³¼ì²œ", "ê°€í‰", "ì–‘í‰", "ì—°ì²œ",
    
    # ì¸ì²œ (10ê°œ êµ¬/êµ°)
    "ì¸ì²œ ì¤‘êµ¬", "ì¸ì²œ ë™êµ¬", "ì¸ì²œ ë¯¸ì¶”í™€êµ¬", "ì¸ì²œ ì—°ìˆ˜êµ¬", "ì¸ì²œ ë‚¨ë™êµ¬",
    "ì¸ì²œ ë¶€í‰êµ¬", "ì¸ì²œ ê³„ì–‘êµ¬", "ì¸ì²œ ì„œêµ¬", "ì¸ì²œ ê°•í™”êµ°", "ì¸ì²œ ì˜¹ì§„êµ°",
    
    # ë¶€ì‚° (16ê°œ êµ¬/êµ°)
    "ë¶€ì‚° ì¤‘êµ¬", "ë¶€ì‚° ì„œêµ¬", "ë¶€ì‚° ë™êµ¬", "ë¶€ì‚° ì˜ë„êµ¬", "ë¶€ì‚° ë¶€ì‚°ì§„êµ¬",
    "ë¶€ì‚° ë™ë˜êµ¬", "ë¶€ì‚° ë‚¨êµ¬", "ë¶€ì‚° ë¶êµ¬", "ë¶€ì‚° í•´ìš´ëŒ€êµ¬", "ë¶€ì‚° ì‚¬í•˜êµ¬",
    "ë¶€ì‚° ê¸ˆì •êµ¬", "ë¶€ì‚° ê°•ì„œêµ¬", "ë¶€ì‚° ì—°ì œêµ¬", "ë¶€ì‚° ìˆ˜ì˜êµ¬", "ë¶€ì‚° ì‚¬ìƒêµ¬", "ë¶€ì‚° ê¸°ì¥êµ°",
    
    # ëŒ€êµ¬ (8ê°œ êµ¬/êµ°)
    "ëŒ€êµ¬ ì¤‘êµ¬", "ëŒ€êµ¬ ë™êµ¬", "ëŒ€êµ¬ ì„œêµ¬", "ëŒ€êµ¬ ë‚¨êµ¬", "ëŒ€êµ¬ ë¶êµ¬",
    "ëŒ€êµ¬ ìˆ˜ì„±êµ¬", "ëŒ€êµ¬ ë‹¬ì„œêµ¬", "ëŒ€êµ¬ ë‹¬ì„±êµ°",
    
    # ê´‘ì£¼ (5ê°œ êµ¬)
    "ê´‘ì£¼ ë™êµ¬", "ê´‘ì£¼ ì„œêµ¬", "ê´‘ì£¼ ë‚¨êµ¬", "ê´‘ì£¼ ë¶êµ¬", "ê´‘ì£¼ ê´‘ì‚°êµ¬",
    
    # ëŒ€ì „ (5ê°œ êµ¬)
    "ëŒ€ì „ ë™êµ¬", "ëŒ€ì „ ì¤‘êµ¬", "ëŒ€ì „ ì„œêµ¬", "ëŒ€ì „ ìœ ì„±êµ¬", "ëŒ€ì „ ëŒ€ë•êµ¬",
    
    # ìš¸ì‚° (5ê°œ êµ¬/êµ°)
    "ìš¸ì‚° ì¤‘êµ¬", "ìš¸ì‚° ë‚¨êµ¬", "ìš¸ì‚° ë™êµ¬", "ìš¸ì‚° ë¶êµ¬", "ìš¸ì‚° ìš¸ì£¼êµ°",
    
    # ì„¸ì¢…
    "ì„¸ì¢…",
    
    # ê°•ì› (18ê°œ ì‹œ/êµ°)
    "ì¶˜ì²œ", "ì›ì£¼", "ê°•ë¦‰", "ë™í•´", "íƒœë°±", "ì†ì´ˆ", "ì‚¼ì²™",
    "í™ì²œ", "íš¡ì„±", "ì˜ì›”", "í‰ì°½", "ì •ì„ ", "ì² ì›", "í™”ì²œ", "ì–‘êµ¬", "ì¸ì œ", "ê³ ì„±", "ì–‘ì–‘",
    
    # ì¶©ë¶ (11ê°œ ì‹œ/êµ°)
    "ì²­ì£¼", "ì¶©ì£¼", "ì œì²œ", "ë³´ì€", "ì˜¥ì²œ", "ì˜ë™", "ì¦í‰", "ì§„ì²œ", "ê´´ì‚°", "ìŒì„±", "ë‹¨ì–‘",
    
    # ì¶©ë‚¨ (15ê°œ ì‹œ/êµ°)
    "ì²œì•ˆ", "ê³µì£¼", "ë³´ë ¹", "ì•„ì‚°", "ì„œì‚°", "ë…¼ì‚°", "ê³„ë£¡", "ë‹¹ì§„",
    "ê¸ˆì‚°", "ë¶€ì—¬", "ì„œì²œ", "ì²­ì–‘", "í™ì„±", "ì˜ˆì‚°", "íƒœì•ˆ",
    
    # ì „ë¶ (14ê°œ ì‹œ/êµ°)
    "ì „ì£¼", "êµ°ì‚°", "ìµì‚°", "ì •ì", "ë‚¨ì›", "ê¹€ì œ",
    "ì™„ì£¼", "ì§„ì•ˆ", "ë¬´ì£¼", "ì¥ìˆ˜", "ì„ì‹¤", "ìˆœì°½", "ê³ ì°½", "ë¶€ì•ˆ",
    
    # ì „ë‚¨ (22ê°œ ì‹œ/êµ°)
    "ëª©í¬", "ì—¬ìˆ˜", "ìˆœì²œ", "ë‚˜ì£¼", "ê´‘ì–‘",
    "ë‹´ì–‘", "ê³¡ì„±", "êµ¬ë¡€", "ê³ í¥", "ë³´ì„±", "í™”ìˆœ", "ì¥í¥", "ê°•ì§„",
    "í•´ë‚¨", "ì˜ì•”", "ë¬´ì•ˆ", "í•¨í‰", "ì˜ê´‘", "ì¥ì„±", "ì™„ë„", "ì§„ë„", "ì‹ ì•ˆ",
    
    # ê²½ë¶ (23ê°œ ì‹œ/êµ°)
    "í¬í•­", "ê²½ì£¼", "ê¹€ì²œ", "ì•ˆë™", "êµ¬ë¯¸", "ì˜ì£¼", "ì˜ì²œ", "ìƒì£¼", "ë¬¸ê²½", "ê²½ì‚°",
    "êµ°ìœ„", "ì˜ì„±", "ì²­ì†¡", "ì˜ì–‘", "ì˜ë•", "ì²­ë„", "ê³ ë ¹", "ì„±ì£¼", "ì¹ ê³¡",
    "ì˜ˆì²œ", "ë´‰í™”", "ìš¸ì§„", "ìš¸ë¦‰",
    
    # ê²½ë‚¨ (18ê°œ ì‹œ/êµ°)
    "ì°½ì›", "ì§„ì£¼", "í†µì˜", "ì‚¬ì²œ", "ê¹€í•´", "ë°€ì–‘", "ê±°ì œ", "ì–‘ì‚°",
    "ì˜ë ¹", "í•¨ì•ˆ", "ì°½ë…•", "ê³ ì„±", "ë‚¨í•´", "í•˜ë™", "ì‚°ì²­", "í•¨ì–‘", "ê±°ì°½", "í•©ì²œ",
    
    # ì œì£¼ (2ê°œ ì‹œ)
    "ì œì£¼ì‹œ", "ì„œê·€í¬ì‹œ"
]

def collect_cafe_data(region, with_images=False):
    """ì§€ì—­ë³„ ì¹´í˜ ë°ì´í„° ìˆ˜ì§‘"""
    print(f"\n{'='*60}")
    print(f"ğŸ“ {region} ìˆ˜ì§‘ ì‹œì‘")
    print(f"{'='*60}")
    
    try:
        # ì¹´ê³µ ì¹´í˜ ê²€ìƒ‰
        result = analyze_blog_content("ì¹´í˜", f"{region} ì¹´ê³µ")
        
        if not result or result.get('totalScore', 0) == 0:
            print(f"  âš ï¸  ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ")
            return 0
        
        blog_count = result.get('blogCount', 0)
        print(f"  ğŸ“Š ë¸”ë¡œê·¸ ë¦¬ë·°: {blog_count}ê°œ")
        print(f"  â­ ì ìˆ˜: {result.get('totalScore', 0)}")
        
        # ì´ë¯¸ì§€ ìˆ˜ì§‘ (ë¸”ë¡œê·¸ 10ê°œ ì´ìƒë§Œ)
        image_urls = []
        if with_images and blog_count >= 10:
            blogs = result.get('blogItems', [])
            if blogs:
                first_blog_url = blogs[0].get('url')
                if first_blog_url:
                    print(f"  ğŸ“· ì´ë¯¸ì§€ ì—…ë¡œë“œ ì¤‘...")
                    image_urls = download_and_upload_blog_images(
                        first_blog_url,
                        f"{region}_cafe",
                        max_images=5
                    )
                    if image_urls:
                        print(f"  âœ… ì´ë¯¸ì§€ {len(image_urls)}ê°œ ì—…ë¡œë“œ")
        
        # DB ì €ì¥
        cafe_name = f"{region} ì¹´í˜"
        save_cached_result(cafe_name, region, CACHE_VERSION, result, 
                          image_urls[0] if image_urls else None)
        
        print(f"  ğŸ’¾ ì €ì¥ ì™„ë£Œ")
        time.sleep(0.3)  # API rate limit
        return 1
        
    except Exception as e:
        print(f"  âŒ ì˜¤ë¥˜: {e}")
        return 0

def main():
    print("=" * 60)
    print("ğŸš€ ì „êµ­ ì¹´í˜ ë°ì´í„° ëŒ€ê·œëª¨ ìˆ˜ì§‘ ì‹œì‘")
    print("=" * 60)
    print(f"ì´ ì§€ì—­ ìˆ˜: {len(REGIONS)}ê°œ")
    print("=" * 60)
    
    # DB ì´ˆê¸°í™”
    init_cache_db()
    
    total = 0
    success = 0
    
    for i, region in enumerate(REGIONS, 1):
        print(f"\n[{i}/{len(REGIONS)}] {region}")
        
        # ë¸”ë¡œê·¸ ë¦¬ë·° ë§ì€ ì¹´í˜ë§Œ ì´ë¯¸ì§€ ìˆ˜ì§‘
        result = collect_cafe_data(region, with_images=True)
        success += result
        total += 1
        
        # 100ê°œë§ˆë‹¤ ì§„í–‰ìƒí™© ì¶œë ¥
        if i % 50 == 0:
            print(f"\n{'='*60}")
            print(f"ğŸ“Š ì¤‘ê°„ ì§‘ê³„: {success}/{total} ì„±ê³µ ({success/total*100:.1f}%)")
            print(f"{'='*60}")
    
    print(f"\n{'='*60}")
    print(f"âœ… ìˆ˜ì§‘ ì™„ë£Œ: {success}/{total} ì„±ê³µ")
    print(f"{'='*60}")

if __name__ == "__main__":
    main()
